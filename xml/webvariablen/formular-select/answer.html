<p>
Aus einer Datenbanktabelle mit einer List Of Values (LOV) soll eine
Selectbox erzeugt werden:
</p>

<pre>&lt;?php
/*
 * lovselection - wandle eine Liste von Werten aus einer Datenbank
 *                in eine option-Liste in HTML.
 *
 * (benutzt PEAR::DB)
 *
 * von Kristian Köhntopp und Frank Wiegand
 *
 */
&nbsp;
function lovselection&#40;$dsn, $table, $field, $oldvalue&#41; &#123;
&nbsp;
  // Rueckgabestring
  $ret = &quot;&quot;;
&nbsp;
  // Datenbankverbindung aufbauen, Fehlerbehandlung
  // ist hier nicht implementiert!
  require_once 'DB.php';
  $db = DB::connect&#40;$dsn&#41;;
&nbsp;
  // Daten auslesen
  $query = sprintf&#40;&quot;SELECT %s FROM %s&quot;,
             $field,
             $table
           &#41;;
&nbsp;
  $res = $db-&gt;query&#40;$query&#41;;
&nbsp;
  while&#40;$row = $db-&gt;fetchRow&#40;&#41;&#41; &#123;
    if &#40;$row&#91;$field&#93; == $oldvalue&#41;
      $selected = &quot; selected='selected'&quot;;
    else
      $selected = &quot;&quot;;
&nbsp;
    $ret .= sprintf&#40;&quot;&lt;option%s&gt;%s&lt;/option&gt;\n&quot;,
                    htmlspecialchars&#40;$selected&#41;,
                    $row&#91;$field&#93;
                   &#41;;
  &#125;
&nbsp;
  $db-&gt;disconnect&#40;&#41;;
  return $ret;
&#125;
&nbsp;
/*
 * is_validlov - überprüfe, ob ein gegebener Wert zu einer
 *               vorgegebenen Liste von Werten passt.
 *
 * von Kristian Köhntopp und Frank Wiegand
 *
 */
function is_validlov&#40;$dsn, $table, $field, $value&#41; &#123;
&nbsp;
  require_once 'DB.php';
  $db = DB::connect&#40;$dsn&#41;;
&nbsp;
  $query = sprintf&#40;&quot;SELECT %s FROM %s WHERE %s = %s&quot;,
             $field,
             $table,
             $field,
             $db-&gt;quote&#40;$value&#41; // Wert für die Abfrage maskieren
           &#41;;
&nbsp;
  $res = $db-&gt;query&#40;$query&#41;;
  if &#40;$res-&gt;numRows&#40;&#41; == 1&#41; &#123;
    $db-&gt;disconnect&#40;&#41;;
    return true;
  &#125; else &#123;
    $db-&gt;disconnect&#40;&#41;;
    return false; // 0 or 2+ answers are a failure!
  &#125;
&#125;
&nbsp;
?&gt;
&nbsp;
&lt;!-- Formularfragment --&gt;
&lt;select name=&quot;f_ortsnetz&quot; size=&quot;1&quot;&gt;
&lt;?php echo lovselection&#40;&quot;mysql://$user:$pass@$host/$db_name&quot;, &quot;ortsnetze&quot;, &quot;vorwahl&quot;, $ortsnetz&#41; ?&gt;
&lt;/select&gt;
&nbsp;
&nbsp;
&lt;!-- Auswertefragment --&gt;
&lt;?php
if &#40;is_validlov&#40;&quot;mysql://$user:$pass@$host/$db_name&quot;, &quot;ortsnetze&quot;, &quot;vorwahl&quot;, $_REQUEST&#91;'f_ortsnetz'&#93;&#41;&#41;
  $ortsnetz = $_REQUEST&#91;'f_ortsnetz'&#93;; // value is valid
else &#123;
  $error&#91;&quot;ortsnetz&quot;&#93; = &quot;Das angegebene Ortsnetz ist ungültig.&quot;;
  $ortsnetz = &quot;&quot;; // clear session variable
&#125;
?&gt;</pre>

<p>
Die Funktion <tt>lovselection()</tt> generiert aus einer Tabelle von
Werten in der Datenbank (eine sogenannte List Of Values, LOV)
eine Reihe von Option-Tags. Man kann dann leicht den passenden
Select-Container drumwickeln. <tt>lovselection()</tt> verwendet die
Datenbank-Klasse <a href="http://pear.php.net/package/DB/">DB</a>
aus dem <a href="http://pear.php.net/">PEAR</a>, läuft also mit
prinzipiell jeder SQL-Datenbank.
</p>

<p>
Wenn man einen solchen Select-Tag generiert, dann heißt das
natürlich nicht, dass das so erzeugte Formular beim Submit
ausschließlich Werte zurückliefert, die man dort zur Auswahl
gestellt hat. Stattdessen kann jeder beliebige Wert
zurück kommen.
</p>

<p>
Es ist also notwendig, dass man ein Prädikat erzeugt, das
überprüft, ob der eingegangene Wert gültig ist. Dieses Prädikat
ist <tt>is_validlov()</tt>: Die Funktion liefert true, wenn der
gegebene Wert genau einmal in der angegebenen Tabelle vorkommt.
</p>

<p>
Im Beispiel kann mit der Variablen <tt>$_REQUEST['f_ortsnetz']</tt>, die aus dem
Formular kommt, nicht gearbeitet werden - sie kann potentiell
ungültige Werte ("003432") enthalten oder sogar potentiell
gefährliche Werte ("0431' or sp_clearall() or '0431", wobei
<tt>sp_clearall()</tt> irgendeine Einbaufunktion oder Stored
Procedure in einer Datenbank ist, die gefährliche Dinge mit der
Datenbank macht).
</p>

<p>
Der Wert von <tt>$_REQUEST['f_ortsnetz']</tt> kann nach <tt>$ortsnetz</tt> kopiert
und gefahrlos verwendet werden genau dann und nur dann, wenn
<tt>is_validlov()</tt> wahr ist, denn dann kommt der Inhalt von
<tt>$_REQUEST['f_ortsnetz']</tt> genau einmal in der angegebenen Tabelle vor und
ist damit eine gültige und garantiert harmlose Auswahl.
</p>

<p>
Die Funktion <tt>is_validlov()</tt> selbst kann sich den Luxus nicht
erlauben, mit harmlosen Werten zu arbeiten und muss daher so
geschrieben sein, dass sie auch mit gefährlichen Inhalten in
<tt>$value</tt> zurecht kommt. Um eine SQL-Injection auszuschließen,
wird $value mit der <tt>quote</tt>-Methode entsprechend für die
Abfrage präpariert.
</p>

