<p>
Grundsätzlich kann man einen Dateidownload auf zwei verschiedene
Arten realisieren: Entweder man schreibt ein PHP-Script, das
einen Redirect (siehe "<a class="faq" href="http://www.php-faq.de/q-http-redirect.html">Wie erzeuge ich mit PHP einen Redirect auf eine andere Seite?</a>")
auf die zu ladende Datei generiert, oder man startet
den Download durch das PHP-Script. Die Methode mit dem Redirect
hat den Nachteil, dass Anwender die Ziel-URL des Redirect
mitbekommen und später dann direkt und ungeschützt auf diese
Datei zugreifen können.
</p>

<p>
Will man das verhindern, muss man den Download innerhalb von PHP abhandeln. Die
zu ladenden Dateien liegen dann außerhalb der Document Root des
Webservers (haben also keine URL) und sind nur durch PHP
zugreifbar. In PHP sendet man den passenden MIME-Typ als Header
und schickt dann die gewünschte Datei hinterher. Natürlich kann
man vorher noch einen Downloadzähler aktualisieren oder
überprüfen, ob der Anwender überhaupt für den Download
autorisiert ist.
</p>

<pre>// $download sei der Bezeichner für die zu ladende Datei
// etwa: 
$download = $_GET&#91;'download'&#93;;
&nbsp;
// Dieses Verzeichnis liegt außerhalb des Document Root und
// ist nicht per URL erreichbar.
$basedir = &quot;/home/www/download&quot;;
&nbsp;
// Übersetzung von Download-Bezeichner in Dateinamen.
$filelist = array&#40;
  &quot;file1&quot; =&gt; &quot;area1/datei1.zip&quot;,
  &quot;file2&quot; =&gt; &quot;area1/datei2.zip&quot;,
  &quot;file3&quot; =&gt; &quot;area2/datei1.zip&quot;
&#41;;
&nbsp;
// Einbruchsversuch abfangen.
if &#40;!isset&#40;$filelist&#91;$download&#93;&#41;&#41;
  die&#40;&quot;Datei $download nicht vorhanden.&quot;&#41;;
&nbsp;
// Vertrauenswürdigen Dateinamen basteln.
$filename = sprintf&#40;&quot;%s/%s&quot;, $basedir, $filelist&#91;$download&#93;&#41;;
&nbsp;
// Passenden Datentyp erzeugen.
header&#40;&quot;Content-Type: application/octet-stream&quot;&#41;;
&nbsp;
// Passenden Dateinamen im Download-Requester vorgeben,
// z. B. den Original-Dateinamen
$save_as_name = basename&#40;$filelist&#91;$download&#93;&#41;;
header&#40;&quot;Content-Disposition: attachment; filename=\&quot;$save_as_name\&quot;&quot;&#41;;
&nbsp;
// Datei ausgeben.
readfile&#40;$filename&#41;;</pre>

<p>
Dieses Script kann mit dem Parameter <tt>$download</tt> aufgerufen
werden. Dieser Parameter wird dann in den Namen einer zu
ladenden Datei übersetzt. Aus Sicherheitsgründen ist es nicht
möglich, dem Script direkt Dateinamen zu übergeben - wir möchten
vermeiden, dass jemand als Parameter
<tt>download=../../../../../../../etc/passwd</tt> oder ähnliche
Namen erfolgreich übergeben kann. Die Prüfung ist eine Variante
des ersten Prüfschemas aus "<a class="faq" href="http://www.php-faq.de/q-security-variablen.html">Wie unterscheide ich böse Variablen von guten?</a>".
</p>

