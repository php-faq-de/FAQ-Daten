<p>
Grundsätzlich kann man einen Dateidownload auf zwei verschiedene
Arten realisieren: Entweder man schreibt ein PHP-Script, das
einen Redirect (siehe "<a class="faq" href="http://www.php-faq.de/q-http-redirect.html">Wie erzeuge ich mit PHP einen Redirect auf eine andere Seite?</a>")
auf die zu ladende Datei generiert, oder man startet
den Download durch das PHP-Script. Die Methode mit dem Redirect
hat den Nachteil, dass Anwender die Ziel-URL des Redirect
mitbekommen und später dann direkt und ungeschützt auf diese
Datei zugreifen können.
</p>

<p>
Will man das verhindern, muss man den Download innerhalb von PHP abhandeln. Die
zu ladenden Dateien liegen dann außerhalb der Document Root des
Webservers (haben also keine URL) und sind nur durch PHP
zugreifbar. In PHP sendet man den passenden MIME-Typ als Header
und schickt dann die gewünschte Datei hinterher. Natürlich kann
man vorher noch einen Downloadzähler aktualisieren oder
überprüfen, ob der Anwender überhaupt für den Download
autorisiert ist.
</p>

<pre><span style="color: #808080; font-style: italic;">// $download sei der Bezeichner für die zu ladende Datei</span>
<span style="color: #808080; font-style: italic;">// etwa: </span>
<span style="color: #0000ff;">$download</span> = <span style="color: #0000ff;">$_GET</span><span style="color: #000000;">&#91;</span><span style="color: #ff0000;">'download'</span><span style="color: #000000;">&#93;</span>;
&nbsp;
<span style="color: #808080; font-style: italic;">// Dieses Verzeichnis liegt außerhalb des Document Root und</span>
<span style="color: #808080; font-style: italic;">// ist nicht per URL erreichbar.</span>
<span style="color: #0000ff;">$basedir</span> = <span style="color: #ff0000;">&quot;/home/www/download&quot;</span>;
&nbsp;
<span style="color: #808080; font-style: italic;">// Übersetzung von Download-Bezeichner in Dateinamen.</span>
<span style="color: #0000ff;">$filelist</span> = <a href="http://www.php3.de/array"><span style="color: #000066;">array</span></a><span style="color: #000000;">&#40;</span>
  <span style="color: #ff0000;">&quot;file1&quot;</span> =&gt; <span style="color: #ff0000;">&quot;area1/datei1.zip&quot;</span>,
  <span style="color: #ff0000;">&quot;file2&quot;</span> =&gt; <span style="color: #ff0000;">&quot;area1/datei2.zip&quot;</span>,
  <span style="color: #ff0000;">&quot;file3&quot;</span> =&gt; <span style="color: #ff0000;">&quot;area2/datei1.zip&quot;</span>
<span style="color: #000000;">&#41;</span>;
&nbsp;
<span style="color: #808080; font-style: italic;">// Einbruchsversuch abfangen.</span>
<span style="color: #b1b100;">if</span> <span style="color: #000000;">&#40;</span>!<a href="http://www.php3.de/isset"><span style="color: #000066;">isset</span></a><span style="color: #000000;">&#40;</span><span style="color: #0000ff;">$filelist</span><span style="color: #000000;">&#91;</span><span style="color: #0000ff;">$download</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>
  <a href="http://www.php3.de/die"><span style="color: #000066;">die</span></a><span style="color: #000000;">&#40;</span><span style="color: #ff0000;">&quot;Datei $download nicht vorhanden.&quot;</span><span style="color: #000000;">&#41;</span>;
&nbsp;
<span style="color: #808080; font-style: italic;">// Vertrauenswürdigen Dateinamen basteln.</span>
<span style="color: #0000ff;">$filename</span> = <a href="http://www.php3.de/sprintf"><span style="color: #000066;">sprintf</span></a><span style="color: #000000;">&#40;</span><span style="color: #ff0000;">&quot;%s/%s&quot;</span>, <span style="color: #0000ff;">$basedir</span>, <span style="color: #0000ff;">$filelist</span><span style="color: #000000;">&#91;</span><span style="color: #0000ff;">$download</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span>;
&nbsp;
<span style="color: #808080; font-style: italic;">// Passenden Datentyp erzeugen.</span>
<a href="http://www.php3.de/header"><span style="color: #000066;">header</span></a><span style="color: #000000;">&#40;</span><span style="color: #ff0000;">&quot;Content-Type: application/octet-stream&quot;</span><span style="color: #000000;">&#41;</span>;
&nbsp;
<span style="color: #808080; font-style: italic;">// Passenden Dateinamen im Download-Requester vorgeben,</span>
<span style="color: #808080; font-style: italic;">// z. B. den Original-Dateinamen</span>
<span style="color: #0000ff;">$save_as_name</span> = <a href="http://www.php3.de/basename"><span style="color: #000066;">basename</span></a><span style="color: #000000;">&#40;</span><span style="color: #0000ff;">$filelist</span><span style="color: #000000;">&#91;</span><span style="color: #0000ff;">$download</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span>;
<a href="http://www.php3.de/header"><span style="color: #000066;">header</span></a><span style="color: #000000;">&#40;</span><span style="color: #ff0000;">&quot;Content-Disposition: attachment; filename=<span style="color: #000099; font-weight: bold;">\&quot;</span>$save_as_name<span style="color: #000099; font-weight: bold;">\&quot;</span>&quot;</span><span style="color: #000000;">&#41;</span>;
&nbsp;
<span style="color: #808080; font-style: italic;">// Datei ausgeben.</span>
<a href="http://www.php3.de/readfile"><span style="color: #000066;">readfile</span></a><span style="color: #000000;">&#40;</span><span style="color: #0000ff;">$filename</span><span style="color: #000000;">&#41;</span>;</pre>

<p>
Dieses Script kann mit dem Parameter <tt>$download</tt> aufgerufen
werden. Dieser Parameter wird dann in den Namen einer zu
ladenden Datei übersetzt. Aus Sicherheitsgründen ist es nicht
möglich, dem Script direkt Dateinamen zu übergeben - wir möchten
vermeiden, dass jemand als Parameter
<tt>download=../../../../../../../etc/passwd</tt> oder ähnliche
Namen erfolgreich übergeben kann. Die Prüfung ist eine Variante
des ersten Prüfschemas aus "<a class="faq" href="http://www.php-faq.de/q-security-variablen.html">Wie unterscheide ich böse Variablen von guten?</a>".
</p>

